#!/bin/bash


venv_dir="./.gemini/venv-fast-mcp"
python_script="./tools/project_mcp.py"

#	check if the virtual environment exists
if [[ ! -d "${venv_dir}" ]];
then
	echo "creating virtual environment in ${venv_dir}..."
	if ! python3 -m venv "${venv_dir}";
	then
		echo "failed to create virtual environment"
		exit 1
	fi
fi

#	activate the virtual environment
#	shellcheck disable=SC1091
source "${venv_dir}/bin/activate"

#	install dependencies if not already installed
install_inside_venv( )
{
	local package_name="${1}"
	if ! "${venv_dir}/bin/pip" show "${package_name}" &>/dev/null;
	then
		echo "installing ${package_name}..."
		if ! env -u LD_PRELOAD "${venv_dir}/bin/pip" install "${package_name}";
		then
			echo "failed to install ${package_name}"
			deactivate #	deactivate venv before exiting
			exit 1
		fi
	fi
}

for package in "fastmcp" "pydantic";
do
	install_inside_venv "${package}"
done

#	execute the original python script with all arguments
env -u LD_PRELOAD "${venv_dir}/bin/python" "${python_script}" "${@}"

#	deactivate the virtual environment
deactivate


