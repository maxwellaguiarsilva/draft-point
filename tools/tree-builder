#!/usr/bin/python3


import glob
import os
import re

config    =    {
     "cpp_version": "c++23"
    ,"file_extension": "cpp"
    ,"file_filter": "*.cpp"
    ,"main_regexp": r"\b(int|auto)\s+main\s*\("
    ,"folders": {
         "source": "source"
        ,"include": "include"
        ,"tests": "tests"
        ,"build": "build"
        ,"dist": "dist"
    }
}



class cpp:
    def __init__( self, path, project ):
        self.project  = project
        self.cpp_path = path

        source_folder = self.project.config["folders"]["source"]
        tests_folder  = self.project.config["folders"]["tests"]
        build_folder  = self.project.config["folders"]["build"]
        main_regexp   = self.project.config["main_regexp"]

        self.is_test = self.__check_if_test( )
        base_folder  = tests_folder if self.is_test else source_folder

        # Remove o prefixo da pasta base e a extensão
        relative_path = os.path.relpath( path, base_folder )
        self.hierarchy = os.path.splitext( relative_path )[0]
        
        # Caminhos no diretório de build
        build_base = os.path.join( build_folder, base_folder )
        self.object_path = os.path.join( build_base, self.hierarchy + ".o" )
        self.dependency_path = self.object_path + ".d"

        with open( path, 'r' ) as f:
            content = f.read( )
            self.is_main = bool( re.search( main_regexp, content ) )

    def __check_if_test( self ):
        return self.cpp_path.startswith( self.project.config["folders"]["tests"] )

    def __repr__( self ):
        return ( f"\ncpp("
            f"\n     hierarchy='{self.hierarchy}'"
            f"\n    ,is_main={self.is_main}"
            f"\n    ,is_test={self.is_test}"
            f"\n    ,cpp_path='{self.cpp_path}'"
            f"\n    ,object_path='{self.object_path}'"
            f"\n    ,dependency_path='{self.object_path}'"
            f"\n)"
        )


class binary_builder:
    def __init__( self, cpp ):
        if not cpp.is_main:
            raise ValueError( f"O arquivo {cpp.cpp_path} não contém uma função main." )
        
        self.cpp = cpp
        dist_folder  = self.cpp.project.config["folders"]["dist"]
        
        # O binário terá apenas o nome do arquivo, sem a extensão e sem a hierarquia
        binary_name = os.path.basename( self.cpp.cpp_path )
        binary_name = os.path.splitext( binary_name )[0]
        self.binary_path = os.path.join( dist_folder, binary_name )

    def __repr__( self ):
        return ( f"\nbinary_builder("
            f"\n     hierarchy='{self.cpp.hierarchy}'"
            f"\n    ,binary_path='{self.binary_path}'"
            f"\n)"
        )


class hpp:
    def __init__( self, path, project ):
        self.project  = project
        self.hpp_path = path
        base_folder   = self.project.config["folders"]["include"]
        relative_path = os.path.relpath( path, base_folder )
        self.hierarchy = os.path.splitext( relative_path )[0]

    def __repr__( self ):
        return ( f"\nhpp("
            f"\n     hierarchy='{self.hierarchy}'"
            f"\n    ,hpp_path='{self.hpp_path}'"
            f"\n)"
        )

class project:
    def __init__( self, config ):
        self.config = config
        include_list    =   glob.glob( os.path.join( config["folders"]["include"], "**/*.hpp" ), recursive=True )
        source_list     =   glob.glob( os.path.join( config["folders"]["source"], "**/*.cpp" ), recursive=True )
        tests_list      =   glob.glob( os.path.join( config["folders"]["tests"], "**/*.cpp" ), recursive=True )

        self.hpp_list = [hpp( p, self ) for p in include_list]
        self.cpp_list = [cpp( p, self ) for p in source_list + tests_list]
        self.binary_list = [binary_builder( c ) for c in self.cpp_list if c.is_main]

        self.hierarchy_items = {}
        for h in self.hpp_list:
            self.hierarchy_items.setdefault( h.hierarchy, { "cpp": None, "hpp": None } )[ "hpp" ] = h
        for c in self.cpp_list:
            self.hierarchy_items.setdefault( c.hierarchy, { "cpp": None, "hpp": None } )[ "cpp" ] = c

    def build( self ):
        print( f"hpp_list = {self.hpp_list}" )
        print( f"cpp_list = {self.cpp_list}" )
        print( f"binary_list = {self.binary_list}" )
        print( f"hierarchy_items = {self.hierarchy_items}" )


project( config ).build( )


