#!/usr/bin/python3


import glob
import os
import re

config    =    {
     "cpp_version": "c++23"
    ,"file_extension": "cpp"
    ,"file_filter": "*.cpp"
    ,"main_regexp": r"\b( int|auto )\s+main\s*\( "
    ,"folders": {
         "source": "source"
        ,"include": "include"
        ,"tests": "tests"
        ,"build": "build"
        ,"dist": "dist"
    }
}

class cpp:
    def __init__( self, path, base_folder ):
        self.cpp_path = path
        # Remove o prefixo da pasta base e a extensão
        relative_path = os.path.relpath( path, base_folder )
        self.hierarchy = os.path.splitext( relative_path )[0]
        
        # Caminhos no diretório de build
        build_base = os.path.join( config["folders"]["build"], base_folder )
        self.object_path = os.path.join( build_base, self.hierarchy + ".o" )
        self.dependency_path = self.object_path + ".d"

        self.is_test = base_folder == config["folders"]["tests"]

        with open( path, 'r' ) as f:
            content = f.read( )
            self.is_main = bool( re.search( config["main_regexp"], content ) )

    def __repr__( self ):
        return ( f"\ncpp("
            f"\n     hierarchy='{self.hierarchy}'"
            f"\n    ,is_main={self.is_main}"
            f"\n    ,is_test={self.is_test}"
            f"\n    ,cpp_path='{self.cpp_path}'"
            f"\n    ,object_path='{self.object_path}'"
            f"\n    ,dependency_path='{self.object_path}'"
            f"\n)"
        )


class hpp:
    def __init__( self, path, base_folder ):
        self.hpp_path = path
        relative_path = os.path.relpath( path, base_folder )
        self.hierarchy = os.path.splitext( relative_path )[0]

    def __repr__( self ):
        return f"hpp( hierarchy='{self.hierarchy}', hpp_path='{self.hpp_path}' )"

class project:
    def __init__( self, config ):
        self.config = config
        include_list    =   glob.glob( os.path.join( config["folders"]["include"], "**/*.hpp" ), recursive=True )
        source_list     =   glob.glob( os.path.join( config["folders"]["source"], "**/*.cpp" ), recursive=True )
        tests_list      =   glob.glob( os.path.join( config["folders"]["tests"], "**/*.cpp" ), recursive=True )

        self.hpp_list = [hpp( p, config["folders"]["include"] ) for p in include_list]
        self.cpp_list = [cpp( p, config["folders"]["source"] ) for p in source_list] + [cpp( p, config["folders"]["tests"] ) for p in tests_list]

    def build( self ):
        print( f"hpp_list = {self.hpp_list}" )
        print( f"cpp_list = {self.cpp_list}" )


project( config ).build( )


